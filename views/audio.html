<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="stylesheet" type="text/css" href="assets/audio.css" />

  <title>Audio API</title>
</head>

<body>
<div class="container">
  <section id="synth">
    <button data-sound="arps" data-mute="undef">Arps</button>
    <button data-sound="laser">Laser</button>
    <button data-sound="kick">Kick</button>
    <button data-sound="snare">Snare?</button>
    <button data-sound="hh" data-mute="undef">Hi Hat</button>
  </section>
</div>


<script type="text/javascript">

// dom / buttons
const buttons = document.querySelectorAll('button'),
  arpButton = document.querySelector('button[data-sound="arps"]'),
  hhButton = document.querySelector('button[data-sound="hh"]'),
  synth = document.querySelector('#synth');
console.log(buttons);

synth.addEventListener("click", function(evt) {
  let button = evt.target;
  console.log(button);

  // arpegiator controls
  if (button.dataset.sound === "arps") {

    if (button.dataset.mute === "true") {

      arpsGain.gain.value = 1;
      button.dataset.mute = "false";

    } else if (button.dataset.mute === "false") {

      arpsGain.gain.value = 0;
      button.dataset.mute = "true";

    } else {

      arpsSource.connect(arpsGain).connect(context.destination);
      arpsSource.start();
      arpsSource.loop = true;
      button.dataset.mute = "false";
    }
      
  }

  if (button.dataset.sound === "laser") {
    playLaser();
  }

  if (button.dataset.sound === "snare") {
    playSnare();
  }

  if (button.dataset.sound === "kick") {
    playKick();
  }

  // if (button.dataset.sound === "hh") {
  //   playHiHat();
  // }
  // play();
});

// start audio stuff

const context = new window.AudioContext;

// nodes
const arpsSource = context.createBufferSource(),
  arpsGain = context.createGain();

fetch('media/100_C_G_Arps_SP_01.wav')
  // read into memory as array buffer
  .then(response => response.arrayBuffer())
  // turn into raw audio data
  .then(arrayBuffer => context.decodeAudioData(arrayBuffer))
  .then(audioBuffer => {
    arpsSource.buffer = audioBuffer;
  })
// (see https://jakearchibald.com/2016/sounds-fun/)

// hi hat
fetch('media/808CHH.wav')
  // read into memory as array buffer
  .then(response => response.arrayBuffer())
  // turn into raw audio data
  .then(arrayBuffer => context.decodeAudioData(arrayBuffer))
  .then(audioBuffer => {

    hhButton.addEventListener("click", function(evt) {
      const hh = context.createBufferSource();
      hh.buffer = audioBuffer;
      hh.connect(context.destination);
      hh.start();
      hh.stop(context.currentTime+0.5);
    });

  })


// function playHiHat() {
//   const hh = context.createBufferSource();
//   hh.buffer = hhBuffer;
//   hh.connect(context.destination);
//   hh.start();
//   hh.stop(context.currentTime+0.5);
// }

function playLaser() {
  const laser = context.createOscillator();
  laser.frequency.value = 523.251;
  laser.type = 'square';
  laser.frequency.exponentialRampToValueAtTime(10, context.currentTime+1);

  const laserGain = context.createGain();
  // set gain value to 1 'now'
  laserGain.gain.setValueAtTime(1, context.currentTime)
  // decease suddenly but smoothly
  laserGain.gain.exponentialRampToValueAtTime(0.001, context.currentTime+0.9);
  laser.connect(laserGain).connect(context.destination);
  laser.start(context.currentTime);
  laser.stop(context.currentTime+1);
}

function playSnare() {
  const snareBufferSize = context.sampleRate;
  // pass in channels, frame count, sample rate
  const snareBuffer = context.createBuffer(1, snareBufferSize, context.sampleRate);
  const snare = context.createBufferSource();

  // create some data for the buffer
  var snareData = snareBuffer.getChannelData(0);

  for (let i=0; i<snareBufferSize; i++) {
    snareData[i] = Math.random()*2 - 1;
  }

  snare.buffer = snareBuffer;

  // create a filter
  const snareFilter = context.createBiquadFilter();
  snareFilter.type = "bandpass";
  snareFilter.frequency = 15000;
  snareFilter.Q = 0.0001;

  // create gain
  const snareGain = context.createGain();
  snareGain.gain.setValueAtTime(3,context.currentTime);
  snareGain.gain.exponentialRampToValueAtTime(0.01, context.currentTime+0.3);

  snare.connect(snareFilter).connect(snareGain).connect(context.destination);
  snare.start(context.currentTime);
  snare.stop(context.currentTime+0.5);
}

function playKick() {
  const kick = context.createOscillator();
  kick.frequency = 150;
  kick.frequency.setValueAtTime(150, context.currentTime);
  kick.frequency.exponentialRampToValueAtTime(0.01, context.currentTime+0.5);

  kickGain = context.createGain();
  kickGain.gain.setValueAtTime(2,context.currentTime);
  kickGain.gain.exponentialRampToValueAtTime(0.01,context.currentTime+0.4);

  kick.connect(kickGain).connect(context.destination);
  kick.start(context.currentTime);
  kick.stop(context.currentTime+0.5);
}
// see Chris Lowis https://dev.opera.com/articles/drum-sounds-webaudio/

// hi hat


// hhGain = context.createGain();



// function playSnare() {
//   const snareBufferSize = context.sampleRate;
//   // pass in channels, frame count, sample rate
//   const snareBuffer = context.createBuffer(1, snareBufferSize, context.sampleRate);
//   const snare = context.createBufferSource();

//   // create some data for the buffer
//   var snareData = snareBuffer.getChannelData(0);

//   for (let i=0; i<snareBufferSize; i++) {
//     snareData[i] = Math.random()*2 - 1;
//   }
//   console.log(snareData);

//   snare.buffer = snareBuffer;
//   snare.connect(context.destination);
//   snare.start(context.currentTime);
//   snare.stop(context.currentTime+0.5);
// }



</script>
</body>